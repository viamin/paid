<% content_for(:title) { "#{@project.name} - Projects - Paid" } %>

<div class="mx-auto max-w-7xl px-4 py-8 sm:px-6 lg:px-8">
  <div class="mb-6">
    <%= link_to projects_path, class: "inline-flex items-center text-sm font-medium text-gray-500 hover:text-gray-700" do %>
      <svg class="mr-1 h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
        <path fill-rule="evenodd" d="M17 10a.75.75 0 0 1-.75.75H5.612l4.158 3.96a.75.75 0 1 1-1.04 1.08l-5.5-5.25a.75.75 0 0 1 0-1.08l5.5-5.25a.75.75 0 1 1 1.04 1.08L5.612 9.25H16.25A.75.75 0 0 1 17 10Z" clip-rule="evenodd" />
      </svg>
      Back to Projects
    <% end %>
  </div>

  <div class="bg-white shadow sm:rounded-lg">
    <div class="px-4 py-5 sm:px-6">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-xl font-semibold text-gray-900"><%= @project.name %></h1>
          <p class="mt-1 text-sm text-gray-500">
            <%= link_to @project.full_name, @project.github_url, target: "_blank", rel: "noopener noreferrer", class: "hover:text-indigo-600" %>
          </p>
        </div>
        <div class="flex items-center space-x-3">
          <% if @project.active? %>
            <span class="inline-flex items-center rounded-md bg-green-100 px-3 py-1 text-sm font-medium text-green-700">
              Active
            </span>
          <% else %>
            <span class="inline-flex items-center rounded-md bg-gray-100 px-3 py-1 text-sm font-medium text-gray-600">
              Inactive
            </span>
          <% end %>
          <% if policy(@project).update? %>
            <%= link_to edit_project_path(@project), class: "inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50" do %>
              <svg class="-ml-0.5 mr-1.5 h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path d="m5.433 13.917 1.262-3.155A4 4 0 0 1 7.58 9.42l6.92-6.918a2.121 2.121 0 0 1 3 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 0 1-.65-.65Z" />
                <path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0 0 10 3H4.75A2.75 2.75 0 0 0 2 5.75v9.5A2.75 2.75 0 0 0 4.75 18h9.5A2.75 2.75 0 0 0 17 15.25V10a.75.75 0 0 0-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5Z" />
              </svg>
              Edit
            <% end %>
          <% end %>
        </div>
      </div>
    </div>

    <div class="border-t border-gray-200">
      <dl class="divide-y divide-gray-200">
        <div class="px-4 py-4 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
          <dt class="text-sm font-medium text-gray-500">GitHub Token</dt>
          <dd class="mt-1 text-sm text-gray-900 sm:col-span-2 sm:mt-0">
            <%= link_to @project.github_token.name, github_token_path(@project.github_token), class: "text-indigo-600 hover:text-indigo-900" %>
          </dd>
        </div>

        <div class="px-4 py-4 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
          <dt class="text-sm font-medium text-gray-500">Default Branch</dt>
          <dd class="mt-1 text-sm text-gray-900 sm:col-span-2 sm:mt-0">
            <code class="rounded bg-gray-100 px-2 py-1 font-mono text-sm"><%= @project.default_branch %></code>
          </dd>
        </div>

        <div class="px-4 py-4 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
          <dt class="text-sm font-medium text-gray-500">Poll Interval</dt>
          <dd class="mt-1 text-sm text-gray-900 sm:col-span-2 sm:mt-0">
            Every <%= pluralize(@project.poll_interval_seconds, "second") %>
          </dd>
        </div>

        <div class="px-4 py-4 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
          <dt class="text-sm font-medium text-gray-500">Trusted GitHub Users</dt>
          <dd class="mt-1 text-sm text-gray-900 sm:col-span-2 sm:mt-0">
            <% if @project.allowed_github_usernames.any? %>
              <div class="flex flex-wrap gap-1">
                <% @project.allowed_github_usernames.each do |username| %>
                  <span class="inline-flex items-center rounded-full bg-green-100 px-2.5 py-0.5 text-xs font-medium text-green-800"><%= username %></span>
                <% end %>
              </div>
            <% else %>
              <span class="text-red-600 font-medium">None configured</span>
            <% end %>
          </dd>
        </div>

        <div class="px-4 py-4 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
          <dt class="text-sm font-medium text-gray-500">Added</dt>
          <dd class="mt-1 text-sm text-gray-900 sm:col-span-2 sm:mt-0">
            <%= @project.created_at.strftime("%B %d, %Y at %I:%M %p %Z") %>
            <% if @project.created_by %>
              by <%= @project.created_by.email %>
            <% end %>
          </dd>
        </div>
      </dl>
    </div>
  </div>

  <div class="mt-8">
    <h2 class="text-lg font-medium text-gray-900">Statistics</h2>
    <dl class="mt-4 grid grid-cols-1 gap-5 sm:grid-cols-4">
      <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow sm:p-6">
        <dt class="truncate text-sm font-medium text-gray-500">Total Runs</dt>
        <dd class="mt-1 text-3xl font-semibold tracking-tight text-gray-900"><%= @project.agent_runs.count %></dd>
      </div>

      <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow sm:p-6">
        <dt class="truncate text-sm font-medium text-gray-500">Completed</dt>
        <dd class="mt-1 text-3xl font-semibold tracking-tight text-green-600"><%= @project.agent_runs.completed.count %></dd>
      </div>

      <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow sm:p-6">
        <dt class="truncate text-sm font-medium text-gray-500">Total Cost</dt>
        <dd class="mt-1 text-3xl font-semibold tracking-tight text-gray-900">$<%= format("%.2f", @project.total_cost_cents / 100.0) %></dd>
      </div>

      <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow sm:p-6">
        <dt class="truncate text-sm font-medium text-gray-500">Tokens Used</dt>
        <dd class="mt-1 text-3xl font-semibold tracking-tight text-gray-900"><%= number_with_delimiter(@project.total_tokens_used) %></dd>
      </div>
    </dl>
  </div>

  <div class="mt-8">
    <h2 class="text-lg font-medium text-gray-900">Synced Issues</h2>

    <% if @issues.any? %>
      <div class="mt-4 overflow-hidden bg-white shadow sm:rounded-lg">
        <div class="max-h-96 overflow-y-auto">
          <ul role="list" class="divide-y divide-gray-200">
            <% @issues.each do |issue| %>
              <li class="flex items-center justify-between px-4 py-3">
                <div class="min-w-0 flex-1">
                  <div class="flex items-center space-x-2">
                    <%= link_to "##{issue.github_number}",
                          issue.github_url,
                          target: "_blank",
                          rel: "noopener noreferrer",
                          class: "flex-shrink-0 text-sm font-medium text-indigo-600 hover:text-indigo-900" %>
                    <span class="truncate text-sm text-gray-900"><%= issue.title %></span>
                  </div>
                  <% if issue.labels.any? %>
                    <div class="mt-1 flex flex-wrap gap-1">
                      <% issue.labels.each do |label| %>
                        <span class="inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-xs text-gray-600"><%= label %></span>
                      <% end %>
                    </div>
                  <% end %>
                </div>
                <div class="ml-4 flex-shrink-0">
                  <%= paid_state_badge(issue.paid_state) %>
                </div>
              </li>
            <% end %>
          </ul>
        </div>
      </div>
    <% else %>
      <div class="mt-4 text-center rounded-lg border-2 border-dashed border-gray-300 p-8">
        <h3 class="text-sm font-semibold text-gray-900">No synced issues</h3>
        <p class="mt-1 text-sm text-gray-500">Issues will appear here once they are synced from GitHub.</p>
      </div>
    <% end %>
  </div>

  <div class="mt-8">
    <h2 class="text-lg font-medium text-gray-900">Synced Pull Requests</h2>

    <% if @pull_requests.any? %>
      <div class="mt-4 overflow-hidden bg-white shadow sm:rounded-lg">
        <div class="max-h-96 overflow-y-auto">
          <ul role="list" class="divide-y divide-gray-200">
            <% @pull_requests.each do |pr| %>
              <li class="flex items-center justify-between px-4 py-3">
                <div class="min-w-0 flex-1">
                  <div class="flex items-center space-x-2">
                    <%= link_to "##{pr.github_number}",
                          pr.github_url,
                          target: "_blank",
                          rel: "noopener noreferrer",
                          class: "flex-shrink-0 text-sm font-medium text-indigo-600 hover:text-indigo-900" %>
                    <span class="truncate text-sm text-gray-900"><%= pr.title %></span>
                  </div>
                  <% if pr.labels.any? %>
                    <div class="mt-1 flex flex-wrap gap-1">
                      <% pr.labels.each do |label| %>
                        <span class="inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-xs text-gray-600"><%= label %></span>
                      <% end %>
                    </div>
                  <% end %>
                </div>
                <div class="ml-4 flex-shrink-0">
                  <%= paid_state_badge(pr.paid_state) %>
                </div>
              </li>
            <% end %>
          </ul>
        </div>
      </div>
    <% else %>
      <div class="mt-4 text-center rounded-lg border-2 border-dashed border-gray-300 p-8">
        <h3 class="text-sm font-semibold text-gray-900">No synced pull requests</h3>
        <p class="mt-1 text-sm text-gray-500">Pull requests will appear here once they are synced from GitHub.</p>
      </div>
    <% end %>
  </div>

  <div class="mt-8">
    <h2 class="text-lg font-medium text-gray-900">Workflow Status</h2>
    <div class="mt-4">
      <%= turbo_frame_tag "workflow-status", src: project_workflow_status_path(@project), loading: :lazy do %>
        <div class="animate-pulse bg-gray-100 h-24 rounded-lg"></div>
      <% end %>
    </div>
  </div>

  <div class="mt-8">
    <div class="sm:flex sm:items-center sm:justify-between">
      <h2 class="text-lg font-medium text-gray-900">
        <%= link_to "Recent Agent Runs", project_agent_runs_path(@project), class: "hover:text-indigo-600" %>
      </h2>
      <% if policy(@project).run_agent? %>
        <%= link_to new_project_agent_run_path(@project), class: "mt-4 inline-flex items-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 sm:mt-0" do %>
          <svg class="-ml-0.5 mr-1.5 h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
            <path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16ZM9.555 7.168A1 1 0 0 0 8 8v4a1 1 0 0 0 1.555.832l3-2a1 1 0 0 0 0-1.664l-3-2Z" clip-rule="evenodd" />
          </svg>
          Trigger Run
        <% end %>
      <% end %>
    </div>

    <% if @recent_agent_runs.any? %>
      <div class="mt-4 flow-root">
        <div class="-mx-4 -my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
          <div class="inline-block min-w-full py-2 align-middle sm:px-6 lg:px-8">
            <div class="overflow-hidden shadow ring-1 ring-black ring-opacity-5 sm:rounded-lg">
              <table class="min-w-full divide-y divide-gray-300">
                <thead class="bg-gray-50">
                  <tr>
                    <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-6">Status</th>
                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Agent</th>
                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Branch</th>
                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Duration</th>
                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Tokens</th>
                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Cost</th>
                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Started</th>
                    <th scope="col" class="relative py-3.5 pl-3 pr-4 sm:pr-6">
                      <span class="sr-only">Actions</span>
                    </th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 bg-white">
                  <% @recent_agent_runs.each do |run| %>
                    <tr>
                      <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm sm:pl-6">
                        <%= agent_run_status_badge(run.status) %>
                      </td>
                      <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
                        <%= run.agent_type.titleize %>
                      </td>
                      <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
                        <% if run.branch_name.present? %>
                          <code class="rounded bg-gray-100 px-1 py-0.5 text-xs"><%= run.branch_name %></code>
                        <% else %>
                          <span class="text-gray-400">-</span>
                        <% end %>
                      </td>
                      <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
                        <% if run.duration_seconds.present? %>
                          <%= run.duration_seconds %>s
                        <% elsif run.running? && run.started_at.present? %>
                          <%= (Time.current - run.started_at).to_i %>s
                        <% else %>
                          <span class="text-gray-400">-</span>
                        <% end %>
                      </td>
                      <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
                        <% if run.tokens_input.present? || run.tokens_output.present? %>
                          <%= number_with_delimiter((run.tokens_input || 0) + (run.tokens_output || 0)) %>
                        <% else %>
                          <span class="text-gray-400">-</span>
                        <% end %>
                      </td>
                      <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
                        <% if run.cost_cents.present? && run.cost_cents > 0 %>
                          $<%= format("%.2f", run.cost_cents / 100.0) %>
                        <% else %>
                          <span class="text-gray-400">-</span>
                        <% end %>
                      </td>
                      <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
                        <% if run.started_at.present? %>
                          <%= time_ago_in_words(run.started_at) %> ago
                        <% else %>
                          <%= time_ago_in_words(run.created_at) %> ago
                        <% end %>
                      </td>
                      <td class="relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-6">
                        <%= link_to "View", project_agent_run_path(@project, run), class: "text-indigo-600 hover:text-indigo-900" %>
                        <% if run.pull_request_url.present? %>
                          &middot;
                          <%= link_to "PR", run.pull_request_url, target: "_blank", rel: "noopener noreferrer", class: "text-indigo-600 hover:text-indigo-900" %>
                        <% end %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    <% else %>
      <div class="mt-4 text-center rounded-lg border-2 border-dashed border-gray-300 p-12">
        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        <h3 class="mt-2 text-sm font-semibold text-gray-900">No agent runs yet</h3>
        <p class="mt-1 text-sm text-gray-500">Agent runs will appear here once the workflow execution is enabled.</p>
      </div>
    <% end %>
  </div>

  <% if policy(@project).destroy? %>
    <div class="mt-8 bg-white shadow sm:rounded-lg">
      <div class="px-4 py-5 sm:p-6">
        <div class="sm:flex sm:items-start sm:justify-between">
          <div>
            <h3 class="text-base font-semibold leading-6 text-gray-900">Delete Project</h3>
            <div class="mt-2 max-w-xl text-sm text-gray-500">
              <p>Permanently remove this project and all associated agent runs. This action cannot be undone.</p>
            </div>
          </div>
          <div class="mt-5 sm:ml-6 sm:mt-0 sm:flex sm:flex-shrink-0 sm:items-center">
            <%= button_to "Delete Project", project_path(@project), method: :delete, class: "inline-flex items-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-red-500", form: { data: { turbo_confirm: "Are you sure you want to delete this project? All agent runs will be permanently deleted." } } %>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>
