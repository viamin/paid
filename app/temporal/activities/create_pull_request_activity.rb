# frozen_string_literal: true

module Activities
  class CreatePullRequestActivity < BaseActivity
    activity_name "CreatePullRequest"

    PAID_GENERATED_LABEL = "paid-generated"

    def execute(input)
      agent_run_id = input[:agent_run_id]
      agent_run = AgentRun.find(agent_run_id)
      project = agent_run.project
      issue = agent_run.issue

      client = project.github_token.client
      pr = client.create_pull_request(
        project.full_name,
        base: project.default_branch,
        head: agent_run.branch_name,
        title: pr_title(issue),
        body: pr_body(issue, agent_run)
      )

      agent_run.complete!(
        result_commit: agent_run.result_commit_sha,
        pr_url: pr.html_url,
        pr_number: pr.number
      )

      add_pr_labels(client, project, pr.number, agent_run_id)

      agent_run.log!("system", "PR created: #{pr.html_url}")

      logger.info(
        message: "agent_execution.pull_request_created",
        agent_run_id: agent_run_id,
        pull_request_url: pr.html_url
      )

      { agent_run_id: agent_run_id, pull_request_url: pr.html_url, pull_request_number: pr.number }
    end

    private

    def pr_title(issue)
      return "Agent changes" unless issue

      "Fix ##{issue.github_number}: #{issue.title}".truncate(255)
    end

    def pr_body(issue, agent_run)
      parts = []
      parts << "## Summary"
      parts << ""
      parts << "This pull request was automatically generated by [Paid](https://github.com/viamin/paid)."
      parts << ""

      if issue
        parts << "Closes ##{issue.github_number}"
        parts << ""
      end

      parts << "### Agent Run Details"
      parts << ""
      parts << "- **Agent**: #{agent_run.agent_type}"
      parts << "- **Run ID**: #{agent_run.id}"
      parts << "- **Duration**: #{format_duration(agent_run.duration_seconds)}"
      parts << "- **Iterations**: #{agent_run.iterations || "N/A"}"
      parts << ""
      parts << "### Metrics"
      parts << ""
      parts << "- **Input tokens**: #{format_number(agent_run.tokens_input)}"
      parts << "- **Output tokens**: #{format_number(agent_run.tokens_output)}"
      parts << "- **Estimated cost**: #{format_cost(agent_run.cost_cents)}"

      parts.join("\n")
    end

    def format_duration(seconds)
      return "N/A" unless seconds

      if seconds < 60
        "#{seconds}s"
      elsif seconds < 3600
        "#{seconds / 60}m #{seconds % 60}s"
      else
        "#{seconds / 3600}h #{(seconds % 3600) / 60}m"
      end
    end

    def format_number(value)
      return "N/A" unless value

      value.to_s.reverse.gsub(/(\d{3})(?=\d)/, '\\1,').reverse
    end

    def format_cost(cents)
      return "N/A" unless cents

      "$#{"%.2f" % (cents / 100.0)}"
    end

    def add_pr_labels(client, project, pr_number, agent_run_id)
      client.add_labels_to_issue(project.full_name, pr_number, [ PAID_GENERATED_LABEL ])
    rescue GithubClient::Error => e
      logger.warn(
        message: "agent_execution.add_pr_labels_failed",
        agent_run_id: agent_run_id,
        pr_number: pr_number,
        error: e.message
      )
    end
  end
end
