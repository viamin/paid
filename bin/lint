#!/usr/bin/env bash
set -euo pipefail

AUTOFIX=false
for arg in "$@"; do
  case "$arg" in
    -A) AUTOFIX=true ;;
    *)
      echo "Usage: bin/lint [-A]"
      echo "  -A  Auto-fix violations (rubocop -A, eslint --fix, markdownlint --fix)"
      exit 1
      ;;
  esac
done

RUBOCOP_ARGS=""
MARKDOWNLINT_ARGS=""
ESLINT_ARGS=""

if [ "${GITHUB_ACTIONS:-}" = "true" ]; then
  RUBOCOP_ARGS="-f github"
fi

if [ "$AUTOFIX" = true ]; then
  RUBOCOP_ARGS="$RUBOCOP_ARGS -A"
  MARKDOWNLINT_ARGS="--fix"
  ESLINT_ARGS="--fix"
fi

echo "== Style: RuboCop =="
bin/rubocop $RUBOCOP_ARGS

echo "== Security: Brakeman =="
bin/brakeman --quiet --no-pager --exit-on-warn --exit-on-error

echo "== Security: Gem audit =="
bin/bundler-audit

echo "== Security: Yarn audit =="
yarn audit

echo "== JavaScript: ESLint =="
npx eslint $ESLINT_ARGS

echo "== Markdown: markdownlint =="
npx markdownlint $MARKDOWNLINT_ARGS --ignore node_modules --ignore vendor '**/*.md'

echo "All checks passed."
